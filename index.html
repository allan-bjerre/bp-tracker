<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BP Tracker</title>
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BP Tracker">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--surface:rgba(30,41,59,0.8);--border:rgba(148,163,184,0.1);--text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;--accent:#38bdf8;--accent2:#818cf8;--red:#f87171;--green:#34d399;--orange:#fbbf24;--glow:rgba(56,189,248,0.15);--radius:16px}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh;overflow-x:hidden;padding-bottom:100px}
        body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(ellipse at 20% 20%,rgba(56,189,248,0.06)0%,transparent 50%),radial-gradient(ellipse at 80% 80%,rgba(129,140,248,0.04)0%,transparent 50%),radial-gradient(ellipse at 50% 50%,rgba(248,113,113,0.03)0%,transparent 60%);z-index:0;pointer-events:none}
        .app{max-width:480px;margin:0 auto;padding:0 1rem;position:relative;z-index:1}
        .header{padding:1.5rem 0 1rem;display:flex;justify-content:space-between;align-items:center}
        .logo{display:flex;align-items:center;gap:0.6rem}
        .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;box-shadow:0 4px 15px rgba(56,189,248,0.3)}
        .logo-text{font-size:1.3rem;font-weight:800;letter-spacing:-0.5px}.logo-text span{color:var(--accent)}
        .header-date{color:var(--text3);font-size:0.8rem;font-weight:500}
        .nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,23,42,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;padding:0.5rem 1rem calc(0.5rem + env(safe-area-inset-bottom));z-index:100}
        .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:0.25rem;padding:0.6rem 0;border:none;background:none;color:var(--text3);font-family:inherit;font-size:0.7rem;font-weight:600;cursor:pointer;transition:all 0.2s;border-radius:12px}
        .nav-item.active{color:var(--accent)}.nav-item svg{width:22px;height:22px}.nav-item.active svg{filter:drop-shadow(0 0 8px rgba(56,189,248,0.5))}
        .tab{display:none}.tab.active{display:block}
        .card{background:var(--surface);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;margin-bottom:1rem;animation:fadeUp 0.4s ease-out both}
        .card-glow{box-shadow:0 0 40px var(--glow),inset 0 1px 0 rgba(255,255,255,0.05)}
        .section-label{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:0.75rem}
        .big-reading{text-align:center;padding:1.5rem 0}
        .big-numbers{font-family:'JetBrains Mono',monospace;font-size:3.5rem;font-weight:700;letter-spacing:-2px;line-height:1;margin-bottom:0.5rem}
        .big-numbers .sys{color:var(--red)}.big-numbers .slash{color:var(--text3);margin:0 .15em}.big-numbers .dia{color:var(--accent)}
        .big-unit{color:var(--text3);font-size:0.85rem;font-weight:500}
        .reading-meta{display:flex;justify-content:center;gap:1.5rem;margin-top:1rem}
        .meta-item{text-align:center}.meta-value{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:1.1rem}.meta-label{font-size:0.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px}
        .status-pill{display:inline-flex;padding:0.35rem 1rem;border-radius:20px;font-size:0.8rem;font-weight:600;margin-top:0.75rem}
        .status-optimal,.status-normal{background:rgba(52,211,153,0.15);color:var(--green)}
        .status-elevated{background:rgba(251,191,36,0.15);color:var(--orange)}
        .status-high{background:rgba(248,113,113,0.15);color:var(--red)}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
        .stat-box{background:rgba(15,23,42,0.5);border:1px solid var(--border);border-radius:12px;padding:1rem;text-align:center}
        .stat-num{font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700}
        .stat-label{font-size:0.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-top:0.25rem}
        .capture-area{border:2px dashed var(--bg3);border-radius:12px;padding:2rem;text-align:center;transition:all 0.3s;position:relative;overflow:hidden;min-height:180px;display:flex;flex-direction:column;align-items:center;justify-content:center}
        .capture-area:active{transform:scale(0.98)}
        .capture-area.has-image{padding:0.5rem;border-style:solid;border-color:var(--accent)}
        .capture-area.has-image img{max-width:100%;max-height:250px;border-radius:8px;object-fit:contain}
        .capture-icon{font-size:2.5rem;margin-bottom:0.5rem;opacity:0.6}
        .capture-text{color:var(--text3);font-size:0.85rem}.capture-text strong{color:var(--text2)}
        .capture-btns{display:flex;gap:0.5rem;margin-top:1rem}.capture-btns .btn{flex:1}
        .btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.25rem;border:none;border-radius:10px;font-family:inherit;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s}
        .btn:active{transform:scale(0.96)}
        .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;box-shadow:0 4px 15px rgba(56,189,248,0.25)}
        .btn-secondary{background:var(--bg3);color:var(--text)}
        .btn-full{width:100%}.btn-lg{padding:1rem 1.5rem;font-size:1rem;border-radius:12px}
        .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
        .form-group{display:flex;flex-direction:column;gap:0.35rem}
        .form-label{font-size:0.75rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
        .form-input,.form-select{background:rgba(15,23,42,0.6);border:1.5px solid var(--border);border-radius:10px;padding:0.75rem;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:1rem;transition:border-color 0.2s;-webkit-appearance:none}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--glow)}
        .form-input::placeholder{color:var(--text3)}
        .form-select{cursor:pointer}.form-select option{background:var(--bg2)}
        .input-big{font-size:1.8rem;font-weight:700;text-align:center;padding:0.5rem}
        .input-big.sys{color:var(--red)}.input-big.dia{color:var(--accent)}.input-big.pls{color:var(--green)}
        .history-item{display:flex;align-items:center;gap:0.75rem;padding:1rem;background:rgba(15,23,42,0.4);border:1px solid var(--border);border-radius:12px;margin-bottom:0.5rem}
        .history-bp{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:1.15rem;min-width:100px}
        .history-bp .sys{color:var(--red)}.history-bp .dia{color:var(--accent)}
        .history-info{flex:1}.history-date{font-size:0.8rem;color:var(--text2);font-weight:500}
        .history-tags{display:flex;gap:0.35rem;margin-top:0.25rem;flex-wrap:wrap}
        .tag{font-size:0.65rem;padding:0.15rem 0.5rem;border-radius:6px;background:rgba(148,163,184,0.1);color:var(--text3);font-weight:600}
        .history-pulse{font-family:'JetBrains Mono',monospace;color:var(--green);font-size:0.85rem;font-weight:600}
        .del-btn{background:none;border:none;color:var(--text3);cursor:pointer;padding:0.5rem;border-radius:8px;font-size:1rem}
        .report-card{background:linear-gradient(135deg,rgba(56,189,248,0.05),rgba(129,140,248,0.05));border:1px solid rgba(56,189,248,0.15)}
        .rec-list{list-style:none}.rec-list li{padding:0.6rem 0;border-bottom:1px solid var(--border);font-size:0.9rem;line-height:1.5}.rec-list li:last-child{border-bottom:none}
        .disclaimer{margin-top:1rem;padding:0.75rem 1rem;background:rgba(251,191,36,0.08);border-left:3px solid var(--orange);border-radius:0 8px 8px 0;font-size:0.8rem;color:var(--text2)}
        .export-btns{display:flex;gap:0.5rem;margin-top:1.25rem}.export-btns .btn{flex:1}
        .empty-state{text-align:center;padding:3rem 1rem;color:var(--text3)}
        .empty-icon{font-size:3rem;margin-bottom:0.75rem;opacity:0.4}
        .toast{position:fixed;top:1.5rem;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--green);color:white;padding:0.75rem 1.5rem;border-radius:12px;font-weight:600;font-size:0.9rem;z-index:200;box-shadow:0 10px 40px rgba(0,0,0,0.3);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);white-space:nowrap}
        .toast.show{transform:translateX(-50%) translateY(0)}
        .toast.warn{background:var(--orange)}
        @keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        input[type="file"]{display:none}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="app">
    <div class="header">
        <div class="logo"><div class="logo-icon">‚ù§Ô∏è‚Äçü©π</div><div class="logo-text">BP<span>Tracker</span></div></div>
        <div class="header-date" id="headerDate"></div>
        <div style="color:var(--text3);font-size:0.6rem;font-weight:500">v3.0</div>
    </div>

    <!-- OVERBLIK -->
    <div class="tab active" id="tab-overview">
        <div class="section-label">Seneste m√•ling</div>
        <div class="card card-glow" id="latestCard"></div>
        <div class="section-label">Denne uge</div>
        <div class="stats-grid" id="weekStats"></div>
        <div class="section-label" style="margin-top:1rem">Udvikling</div>
        <div class="card" id="chartCard" style="display:none"><canvas id="bpChart"></canvas></div>
    </div>

    <!-- NY M√ÖLING -->
    <div class="tab" id="tab-add">
        <div class="section-label">Billede af m√•ler</div>
        <div class="card">
            <div class="capture-area" id="captureArea">
                <div class="capture-icon">üì∑</div>
                <p class="capture-text"><strong>Tag billede eller v√¶lg fra album</strong><br>Indtast derefter v√¶rdierne nedenfor</p>
            </div>
            <input type="file" id="cameraInput" accept="image/*" capture="environment">
            <input type="file" id="albumInput" accept="image/*">
            <input type="file" id="importInput" accept=".json,application/json">
            <div class="capture-btns">
                <button class="btn btn-primary" onclick="document.getElementById('cameraInput').click()">üì∑ Kamera</button>
                <button class="btn btn-secondary" onclick="document.getElementById('albumInput').click()">üñºÔ∏è Album</button>
            </div>
        </div>
        <div class="section-label">Indtast v√¶rdier</div>
        <div class="card">
            <div class="form-grid" style="margin-bottom:0.75rem">
                <div class="form-group"><label class="form-label">Systolisk ‚ñ≤</label><input class="form-input input-big sys" type="number" id="inSys" min="70" max="250" placeholder="120" inputmode="numeric"></div>
                <div class="form-group"><label class="form-label">Diastolisk ‚ñº</label><input class="form-input input-big dia" type="number" id="inDia" min="40" max="150" placeholder="80" inputmode="numeric"></div>
            </div>
            <div class="form-grid">
                <div class="form-group"><label class="form-label">Puls ‚ù§Ô∏è</label><input class="form-input input-big pls" type="number" id="inPulse" min="40" max="200" placeholder="70" inputmode="numeric"></div>
                <div class="form-group"><label class="form-label">Tidspunkt</label><input class="form-input" type="datetime-local" id="inTime" style="font-size:0.85rem"></div>
                <div class="form-group"><label class="form-label">Tid p√• dagen</label>
                    <select class="form-select" id="inTod"><option value="morning">üåÖ Morgen</option><option value="afternoon">‚òÄÔ∏è Eftermiddag</option><option value="evening">üåÜ Aften</option><option value="night">üåô Nat</option></select>
                </div>
                <div class="form-group"><label class="form-label">Situation</label>
                    <select class="form-select" id="inSit"><option value="resting">üòå Hvilende</option><option value="after_exercise">üèÉ Tr√¶ning</option><option value="stressed">üò∞ Stresset</option><option value="after_meal">üçΩÔ∏è M√•ltid</option><option value="before_medication">üíä F√∏r medicin</option><option value="after_medication">üíä Efter medicin</option><option value="work">üíº Arbejde</option><option value="home">üè† Hjemme</option></select>
                </div>
            </div>
            <button class="btn btn-primary btn-full btn-lg" onclick="saveReading()" style="margin-top:1rem">üíæ Gem m√•ling</button>
        </div>
    </div>

    <!-- HISTORIK -->
    <div class="tab" id="tab-history">
        <div class="section-label">M√•lehistorik</div>
        <div id="historyList"></div>
    </div>

    <!-- RAPPORT -->
    <div class="tab" id="tab-report">
        <div class="section-label">L√¶ge-rapport</div>
        <div class="card report-card" id="reportBox"></div>
    </div>
</div>

<nav class="nav">
    <button class="nav-item active" onclick="go('overview',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>Overblik</button>
    <button class="nav-item" onclick="go('add',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Ny m√•ling</button>
    <button class="nav-item" onclick="go('history',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M7 12l4-4 4 4 6-6"/></svg>Historik</button>
    <button class="nav-item" onclick="go('report',this)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>Rapport</button>
</nav>

<div class="toast" id="toast"></div>

<script>
// === STATE ===
var readings = JSON.parse(localStorage.getItem('bpReadings') || '[]');
var hasImg = false;
var bpChart = null;

// === INIT ===
(function(){
    document.getElementById('headerDate').textContent = new Date().toLocaleDateString('da-DK',{weekday:'short',day:'numeric',month:'short'});
    resetForm();
    refresh();
})();

function resetForm(){
    var n=new Date(); n.setMinutes(n.getMinutes()-n.getTimezoneOffset());
    document.getElementById('inTime').value=n.toISOString().slice(0,16);
    var h=new Date().getHours();
    document.getElementById('inTod').value=h<6?'night':h<12?'morning':h<18?'afternoon':'evening';
    document.getElementById('inSys').value='';
    document.getElementById('inDia').value='';
    document.getElementById('inPulse').value='';
    hasImg=false;
    var a=document.getElementById('captureArea');
    a.classList.remove('has-image');
    a.innerHTML='<div class="capture-icon">üì∑</div><p class="capture-text"><strong>Tag billede eller v√¶lg fra album</strong><br>Indtast derefter v√¶rdierne nedenfor</p>';
}

function refresh(){ updateOverview(); updateChart(); showHistory(); }

// === NAV ===
function go(name,el){
    document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});
    document.querySelectorAll('.nav-item').forEach(function(n){n.classList.remove('active')});
    document.getElementById('tab-'+name).classList.add('active');
    if(el)el.classList.add('active');
    if(name==='report')showReport();
    if(name==='overview')updateOverview();
}

// === IMAGE ===
document.getElementById('cameraInput').addEventListener('change',onImg);
document.getElementById('albumInput').addEventListener('change',onImg);
document.getElementById('importInput').addEventListener('change',importJSON);
function onImg(e){
    var file=e.target.files[0]; if(!file)return;
    var reader=new FileReader();
    reader.onload=function(ev){
        hasImg=true;
        var a=document.getElementById('captureArea');
        a.classList.add('has-image');
        a.innerHTML='<img src="'+ev.target.result+'" alt="M√•ler">';
        toast('üì∏ Billede klar ‚Äî indtast v√¶rdierne nedenfor');
        setTimeout(function(){document.getElementById('inSys').focus()},400);
    };
    reader.readAsDataURL(file);
}

// === SAVE ===
function saveReading(){
    var sys=parseInt(document.getElementById('inSys').value);
    var dia=parseInt(document.getElementById('inDia').value);
    var pv=document.getElementById('inPulse').value;
    var pulse=pv?parseInt(pv):null;
    var dt=document.getElementById('inTime').value;
    var tod=document.getElementById('inTod').value;
    var sit=document.getElementById('inSit').value;

    if(!sys||!dia||isNaN(sys)||isNaN(dia)){toast('‚ö†Ô∏è Udfyld systolisk og diastolisk','warn');return;}
    if(sys<70||sys>250){toast('‚ö†Ô∏è Systolisk: 70-250','warn');return;}
    if(dia<40||dia>150){toast('‚ö†Ô∏è Diastolisk: 40-150','warn');return;}

    if(!dt){var n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());dt=n.toISOString().slice(0,16);}

    readings.unshift({id:Date.now(),systolic:sys,diastolic:dia,pulse:pulse,datetime:dt,timeOfDay:tod,situation:sit,status:cat(sys,dia),img:hasImg});
    localStorage.setItem('bpReadings',JSON.stringify(readings));
    resetForm();
    toast('‚úÖ M√•ling gemt!');
    refresh();
}

// === CATEGORIES ===
function cat(s,d){
    if(s<120&&d<80)return'optimal';if(s<130&&d<85)return'normal';if(s<140&&d<90)return'high_normal';
    if(s<160&&d<100)return'grade1';if(s<180&&d<110)return'grade2';return'grade3';
}
function catInfo(c){
    var m={optimal:{t:'Optimalt',c:'status-optimal'},normal:{t:'Normalt',c:'status-normal'},high_normal:{t:'H√∏jt normalt',c:'status-elevated'},grade1:{t:'Hypertension Grad 1',c:'status-high'},grade2:{t:'Hypertension Grad 2',c:'status-high'},grade3:{t:'Hypertension Grad 3',c:'status-high'}};
    return m[c]||m.normal;
}
function todTxt(t){return{morning:'Morgen',afternoon:'Eftermiddag',evening:'Aften',night:'Nat'}[t]||'';}
function sitTxt(s){return{resting:'Hvilende',after_exercise:'Tr√¶ning',stressed:'Stresset',after_meal:'M√•ltid',before_medication:'F√∏r medicin',after_medication:'Efter medicin',work:'Arbejde',home:'Hjemme'}[s]||'';}
function fmtDate(dt){var d=new Date(dt);return d.toLocaleDateString('da-DK',{weekday:'short',day:'numeric',month:'short'})+', '+d.toLocaleTimeString('da-DK',{hour:'2-digit',minute:'2-digit'});}

// === OVERVIEW ===
function updateOverview(){
    var el=document.getElementById('latestCard');
    if(!readings.length){
        el.innerHTML='<div class="empty-state"><div class="empty-icon">üìä</div><p><strong>Ingen m√•linger endnu</strong></p><p>Tilf√∏j din f√∏rste m√•ling</p></div>';
        emptyWeek();return;
    }
    var r=readings[0],ci=catInfo(r.status);
    el.innerHTML='<div class="section-label" style="margin-bottom:0">SENESTE M√ÖLING</div>'
        +'<div class="big-reading">'
        +'<div class="big-numbers"><span class="sys">'+r.systolic+'</span><span class="slash">/</span><span class="dia">'+r.diastolic+'</span></div>'
        +'<div class="big-unit">mmHg</div>'
        +'<div class="status-pill '+ci.c+'">‚óè '+ci.t+'</div>'
        +'</div>'
        +'<div class="reading-meta">'
        +(r.pulse?'<div class="meta-item"><div class="meta-value" style="color:var(--green)">'+r.pulse+'</div><div class="meta-label">Puls</div></div>':'')
        +'<div class="meta-item"><div class="meta-value">'+fmtDate(r.datetime)+'</div><div class="meta-label">Tidspunkt</div></div>'
        +'<div class="meta-item"><div class="meta-value">'+(r.img?'üì∑':'‚úèÔ∏è')+'</div><div class="meta-label">Metode</div></div>'
        +'</div>';

    var wa=new Date();wa.setDate(wa.getDate()-7);
    var wr=readings.filter(function(r){return new Date(r.datetime)>=wa;});
    if(!wr.length){emptyWeek();return;}
    var as=Math.round(wr.reduce(function(s,r){return s+r.systolic;},0)/wr.length);
    var ad=Math.round(wr.reduce(function(s,r){return s+r.diastolic;},0)/wr.length);
    var pr=wr.filter(function(r){return r.pulse;});
    var ap=pr.length?Math.round(pr.reduce(function(s,r){return s+r.pulse;},0)/pr.length):null;
    var ms=Math.max.apply(null,wr.map(function(r){return r.systolic;}));
    var wc=catInfo(cat(as,ad));
    document.getElementById('weekStats').innerHTML=
        '<div class="stat-box"><div class="stat-num">'+as+'/'+ad+'</div><div class="stat-label">Gns. blodtryk</div><div class="status-pill '+wc.c+'" style="margin-top:0.35rem;font-size:0.7rem">'+wc.t+'</div></div>'
        +'<div class="stat-box"><div class="stat-num" style="color:var(--green)">'+(ap||'‚Äî')+'</div><div class="stat-label">Gns. puls</div></div>'
        +'<div class="stat-box"><div class="stat-num" style="color:var(--accent)">'+wr.length+'</div><div class="stat-label">M√•linger</div></div>'
        +'<div class="stat-box"><div class="stat-num" style="color:var(--red)">'+ms+'</div><div class="stat-label">H√∏jeste sys.</div></div>';
}
function emptyWeek(){
    document.getElementById('weekStats').innerHTML='<div class="stat-box"><div class="stat-num" style="color:var(--text3)">‚Äî</div><div class="stat-label">Gns. blodtryk</div></div><div class="stat-box"><div class="stat-num" style="color:var(--text3)">‚Äî</div><div class="stat-label">Gns. puls</div></div><div class="stat-box"><div class="stat-num" style="color:var(--text3)">‚Äî</div><div class="stat-label">M√•linger</div></div><div class="stat-box"><div class="stat-num" style="color:var(--text3)">‚Äî</div><div class="stat-label">H√∏jeste sys.</div></div>';
}

// === HISTORY ===
function showHistory(){
    var el=document.getElementById('historyList');
    if(!readings.length){el.innerHTML='<div class="card"><div class="empty-state"><div class="empty-icon">üìã</div><p><strong>Ingen m√•linger</strong></p></div></div>';return;}
    el.innerHTML=readings.map(function(r){
        var ci=catInfo(r.status);
        return '<div class="history-item">'
            +'<div class="history-bp"><span class="sys">'+r.systolic+'</span>/<span class="dia">'+r.diastolic+'</span></div>'
            +'<div class="history-info"><div class="history-date">'+fmtDate(r.datetime)+'</div>'
            +'<div class="history-tags"><span class="tag">'+todTxt(r.timeOfDay)+'</span><span class="tag">'+sitTxt(r.situation)+'</span><span class="tag '+ci.c+'" style="border:none">'+ci.t+'</span></div></div>'
            +(r.pulse?'<div class="history-pulse">‚ô• '+r.pulse+'</div>':'')
            +'<button class="del-btn" onclick="delReading('+r.id+')">üóë</button></div>';
    }).join('');
}
function delReading(id){
    if(!confirm('Slet denne m√•ling?'))return;
    readings=readings.filter(function(r){return r.id!==id;});
    localStorage.setItem('bpReadings',JSON.stringify(readings));
    refresh();
}

// === REPORT ===
function showReport(){
    var el=document.getElementById('reportBox');
    if(!readings.length){el.innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div><p><strong>Ingen data til rapport</strong></p><p>Tilf√∏j m√•linger for at generere</p></div>';return;}

    var ta=new Date();ta.setDate(ta.getDate()-30);
    var rc=readings.filter(function(r){return new Date(r.datetime)>=ta;});
    var d=rc.length?rc:readings;

    var as=Math.round(d.reduce(function(s,r){return s+r.systolic;},0)/d.length);
    var ad=Math.round(d.reduce(function(s,r){return s+r.diastolic;},0)/d.length);
    var pd=d.filter(function(r){return r.pulse;});
    var ap=pd.length?Math.round(pd.reduce(function(s,r){return s+r.pulse;},0)/pd.length):null;
    var mxs=Math.max.apply(null,d.map(function(r){return r.systolic;}));
    var mns=Math.min.apply(null,d.map(function(r){return r.systolic;}));
    var mxd=Math.max.apply(null,d.map(function(r){return r.diastolic;}));
    var mnd=Math.min.apply(null,d.map(function(r){return r.diastolic;}));

    // Trend
    var trend='';
    if(d.length>=5){
        var f3=d.slice(-3),l3=d.slice(0,3);
        var favg=f3.reduce(function(s,r){return s+r.systolic;},0)/3;
        var lavg=l3.reduce(function(s,r){return s+r.systolic;},0)/3;
        var diff=lavg-favg;
        if(diff>3)trend='üìà Stigende tendens ‚Äî f√∏lg t√¶t med';
        else if(diff<-3)trend='üìâ Faldende tendens (positivt)';
        else trend='‚û°Ô∏è Stabilt niveau';
    }

    // Recommendations
    var recs=[],risk='lav';
    if(as>=140||ad>=90){
        risk='h√∏j';
        recs.push('üö® Gennemsnitlige v√¶rdier er forh√∏jede ‚Äî kontakt din l√¶ge');
        recs.push('üìã Tag denne rapport med til l√¶gebes√∏get');
        recs.push('üíä Overhold medicin pr√¶cist som foreskrevet');
    }else if(as>=130||ad>=85){
        risk='moderat';
        recs.push('‚ö†Ô∏è Let forh√∏jede v√¶rdier ‚Äî tal med din l√¶ge');
        recs.push('ü•ó Reduc√©r saltindtag til under 2g/dag');
        recs.push('üö∂ Min. 30 min fysisk aktivitet dagligt');
    }else{
        recs.push('‚úÖ Dine v√¶rdier er inden for normalomr√•det');
        recs.push('üéØ Forts√¶t dine gode sunde vaner');
    }
    if(trend&&trend.indexOf('Stigende')>-1)recs.push(trend);
    if(d.length<10)recs.push('üìä Tilf√∏j flere m√•linger for mere pr√¶cis analyse');

    var rcol={lav:'var(--green)',moderat:'var(--orange)','h√∏j':'var(--red)'};

    el.innerHTML='<div style="font-size:1.1rem;font-weight:700;margin-bottom:0.25rem">üìã Medicinsk Rapport</div>'
        +'<div style="color:var(--text3);font-size:0.8rem;margin-bottom:1.25rem">Seneste 30 dage ¬∑ '+d.length+' m√•linger ¬∑ Risiko: <span style="color:'+rcol[risk]+';font-weight:700">'+risk+'</span></div>'
        +'<div class="stats-grid" style="margin-bottom:1rem">'
        +'<div class="stat-box"><div class="stat-num" style="color:var(--red)">'+as+'</div><div class="stat-label">Gns. systolisk</div></div>'
        +'<div class="stat-box"><div class="stat-num" style="color:var(--accent)">'+ad+'</div><div class="stat-label">Gns. diastolisk</div></div>'
        +(ap?'<div class="stat-box"><div class="stat-num" style="color:var(--green)">'+ap+'</div><div class="stat-label">Gns. puls</div></div>':'')
        +'<div class="stat-box"><div class="stat-num">'+d.length+'</div><div class="stat-label">M√•linger</div></div>'
        +'<div class="stat-box"><div class="stat-num" style="color:var(--orange)">'+mxs+'/'+mxd+'</div><div class="stat-label">H√∏jeste</div></div>'
        +'<div class="stat-box"><div class="stat-num" style="color:var(--green)">'+mns+'/'+mnd+'</div><div class="stat-label">Laveste</div></div>'
        +'</div>'
        +(trend?'<div style="text-align:center;margin-bottom:1rem;font-weight:600">'+trend+'</div>':'')
        +'<div style="background:rgba(15,23,42,0.4);border-radius:12px;padding:1rem;border:1px solid var(--border)">'
        +'<div style="font-weight:700;margin-bottom:0.5rem">ü©∫ Anbefalinger</div>'
        +'<ul class="rec-list">'+recs.map(function(r){return'<li>'+r+'</li>';}).join('')+'</ul>'
        +'</div>'
        +'<div class="disclaimer"><strong>‚ö†Ô∏è Vigtig:</strong> Denne rapport er et supplement til l√¶gebehandling, ikke en erstatning. Dr√∏ft alle √¶ndringer med din l√¶ge.</div>'
        +'<div class="export-btns"><button class="btn btn-primary" onclick="exportJSON()">üì§ Eksporter</button><button class="btn btn-secondary" onclick="document.getElementById(\'importInput\').click()">üì• Import√©r</button><button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button></div>';
}

// === CHART ===
function updateChart(){
    var card=document.getElementById('chartCard');
    if(!readings.length||typeof Chart==='undefined'){card.style.display='none';return;}
    card.style.display='block';
    var data=readings.slice(0,30).reverse();
    var labels=data.map(function(r){var d=new Date(r.datetime);return d.toLocaleDateString('da-DK',{day:'numeric',month:'short'});});
    var sysData=data.map(function(r){return r.systolic;});
    var diaData=data.map(function(r){return r.diastolic;});
    var pulseData=data.map(function(r){return r.pulse;});
    if(bpChart){bpChart.destroy();}
    bpChart=new Chart(document.getElementById('bpChart'),{
        type:'line',
        data:{labels:labels,datasets:[
            {label:'Systolisk',data:sysData,borderColor:'#f87171',backgroundColor:'rgba(248,113,113,0.08)',tension:0.3,fill:true,pointRadius:3,borderWidth:2},
            {label:'Diastolisk',data:diaData,borderColor:'#38bdf8',backgroundColor:'rgba(56,189,248,0.08)',tension:0.3,fill:true,pointRadius:3,borderWidth:2},
            {label:'Puls',data:pulseData,borderColor:'#34d399',backgroundColor:'rgba(52,211,153,0.05)',tension:0.3,fill:false,pointRadius:2,borderWidth:1.5,borderDash:[5,5]}
        ]},
        options:{responsive:true,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#94a3b8',font:{family:'Plus Jakarta Sans',size:11},usePointStyle:true,pointStyle:'circle'}}},scales:{x:{ticks:{color:'#64748b',font:{size:9},maxRotation:45},grid:{color:'rgba(148,163,184,0.06)'}},y:{ticks:{color:'#64748b',font:{size:10}},grid:{color:'rgba(148,163,184,0.08)'}}}}
    });
}

// === IMPORT ===
function importJSON(e){
    var file=e.target.files[0];if(!file)return;
    var reader=new FileReader();
    reader.onload=function(ev){
        try{
            var json=JSON.parse(ev.target.result);
            var imported=Array.isArray(json)?json:(json.data||[]);
            if(!imported.length){toast('‚ö†Ô∏è Ingen m√•linger fundet i filen','warn');return;}
            var existingIds={};
            readings.forEach(function(r){existingIds[r.id]=true;});
            var added=0;
            imported.forEach(function(r){
                if(r.systolic&&r.diastolic&&!existingIds[r.id]){
                    if(!r.id)r.id=Date.now()+Math.random();
                    if(!r.status)r.status=cat(r.systolic,r.diastolic);
                    readings.push(r);
                    added++;
                }
            });
            readings.sort(function(a,b){return new Date(b.datetime)-new Date(a.datetime);});
            localStorage.setItem('bpReadings',JSON.stringify(readings));
            refresh();
            toast('‚úÖ '+added+' m√•linger importeret!');
        }catch(err){toast('‚ö†Ô∏è Ugyldig fil','warn');}
    };
    reader.readAsText(file);
    e.target.value='';
}

function exportJSON(){
    if(!readings.length)return;
    var blob=new Blob([JSON.stringify({genereret:new Date().toISOString(),antal:readings.length,data:readings},null,2)],{type:'application/json'});
    var a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download='bp-rapport-'+new Date().toISOString().split('T')[0]+'.json';
    a.click();URL.revokeObjectURL(a.href);
    toast('üì§ Rapport eksporteret!');
}

// === TOAST ===
function toast(msg,type){
    var t=document.getElementById('toast');
    t.textContent=msg;
    t.className='toast'+(type==='warn'?' warn':'')+' show';
    setTimeout(function(){t.classList.remove('show');},2500);
}
</script>
</body>
</html>
