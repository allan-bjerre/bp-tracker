<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0f1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<title>BPTracker</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0f1a;
  --bg-card: #111827;
  --bg-card-hover: #1a2332;
  --border: #1e2a3a;
  --text: #e8edf5;
  --text-dim: #7a8ba5;
  --text-muted: #4a5568;
  --accent: #22d3a7;
  --accent-glow: rgba(34, 211, 167, 0.15);
  --warning: #f59e0b;
  --danger: #ef4444;
  --danger-soft: rgba(239, 68, 68, 0.12);
  --optimal: #22d3a7;
  --elevated: #f59e0b;
  --high: #ef4444;
  --radius: 16px;
  --radius-sm: 10px;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  padding-bottom: 90px;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  padding: 20px 20px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.header h1 {
  font-size: 1.5rem;
  font-weight: 700;
  letter-spacing: -0.5px;
}
.header h1 span { color: var(--accent); }
.header-date {
  font-size: 0.8rem;
  color: var(--text-dim);
  font-weight: 400;
}

/* ‚îÄ‚îÄ Tabs / Navigation ‚îÄ‚îÄ */
.tabs {
  display: flex;
  gap: 4px;
  padding: 16px 20px;
  overflow-x: auto;
  scrollbar-width: none;
}
.tabs::-webkit-scrollbar { display: none; }
.tab {
  padding: 8px 18px;
  border-radius: 100px;
  font-size: 0.85rem;
  font-weight: 500;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-dim);
  cursor: pointer;
  white-space: nowrap;
  transition: all 0.2s;
}
.tab.active {
  background: var(--accent);
  color: var(--bg);
  border-color: var(--accent);
  font-weight: 600;
}

/* ‚îÄ‚îÄ Screens ‚îÄ‚îÄ */
.screen { display: none; padding: 0 20px; animation: fadeIn 0.3s ease; }
.screen.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* ‚îÄ‚îÄ Latest Reading Card ‚îÄ‚îÄ */
.latest-card {
  background: linear-gradient(135deg, #111827 0%, #162030 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 16px;
  position: relative;
  overflow: hidden;
}
.latest-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -30%;
  width: 200px;
  height: 200px;
  background: radial-gradient(circle, var(--accent-glow) 0%, transparent 70%);
  pointer-events: none;
}
.latest-label {
  font-size: 0.75rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 500;
  margin-bottom: 12px;
}
.latest-values {
  display: flex;
  align-items: baseline;
  gap: 12px;
}
.bp-big {
  font-family: 'JetBrains Mono', monospace;
  font-size: 3rem;
  font-weight: 600;
  line-height: 1;
  letter-spacing: -2px;
}
.bp-slash { color: var(--text-muted); font-weight: 300; }
.bp-unit {
  font-size: 0.75rem;
  color: var(--text-dim);
  margin-left: 4px;
}
.latest-meta {
  display: flex;
  gap: 20px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}
.meta-item {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.meta-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
.meta-value { font-family: 'JetBrains Mono', monospace; font-size: 0.95rem; font-weight: 600; }

/* ‚îÄ‚îÄ Status Badge ‚îÄ‚îÄ */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 100px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-top: 12px;
}
.status-optimal { background: rgba(34, 211, 167, 0.12); color: var(--optimal); }
.status-elevated { background: rgba(245, 158, 11, 0.12); color: var(--elevated); }
.status-high { background: var(--danger-soft); color: var(--high); }

.status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* ‚îÄ‚îÄ History List ‚îÄ‚îÄ */
.history-list { display: flex; flex-direction: column; gap: 8px; }
.history-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  transition: background 0.2s;
}
.history-left { display: flex; flex-direction: column; gap: 4px; }
.history-bp {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.15rem;
  font-weight: 600;
}
.history-time { font-size: 0.75rem; color: var(--text-dim); }
.history-right { display: flex; align-items: center; gap: 10px; }
.history-pulse {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--text-dim);
}
.delete-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
  font-size: 1.1rem;
  transition: color 0.2s;
}
.delete-btn:hover { color: var(--danger); }

/* ‚îÄ‚îÄ Camera / Capture Screen ‚îÄ‚îÄ */
.camera-container {
  position: relative;
  width: 100%;
  aspect-ratio: 4/3;
  background: #000;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
  border: 1px solid var(--border);
}
.camera-container video,
.camera-container canvas {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.camera-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}
.scan-frame {
  width: 70%;
  height: 50%;
  border: 2px solid var(--accent);
  border-radius: 12px;
  position: relative;
  box-shadow: 0 0 0 2000px rgba(0, 0, 0, 0.4);
}
.scan-line {
  position: absolute;
  top: 0;
  left: 5%;
  width: 90%;
  height: 2px;
  background: var(--accent);
  box-shadow: 0 0 12px var(--accent);
  animation: scanMove 2s ease-in-out infinite;
}
@keyframes scanMove { 0%, 100% { top: 10%; } 50% { top: 85%; } }

.scan-hint {
  font-size: 0.8rem;
  color: var(--text-dim);
  text-align: center;
  margin-bottom: 16px;
  line-height: 1.5;
}

.capture-actions {
  display: flex;
  gap: 12px;
}
.btn {
  flex: 1;
  padding: 16px;
  border-radius: var(--radius-sm);
  font-family: 'DM Sans', sans-serif;
  font-size: 0.9rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.btn-primary {
  background: var(--accent);
  color: var(--bg);
}
.btn-primary:active { transform: scale(0.97); }
.btn-secondary {
  background: var(--bg-card);
  color: var(--text);
  border: 1px solid var(--border);
}

/* ‚îÄ‚îÄ Manual Entry ‚îÄ‚îÄ */
.input-group {
  margin-bottom: 16px;
}
.input-label {
  font-size: 0.75rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
  display: block;
}
.input-row {
  display: flex;
  gap: 12px;
}
.input-field {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.3rem;
  font-weight: 600;
  text-align: center;
  outline: none;
  transition: border-color 0.2s;
  width: 100%;
}
.input-field:focus { border-color: var(--accent); }
.input-field::placeholder { color: var(--text-muted); font-size: 0.9rem; }

/* ‚îÄ‚îÄ Analysis Card ‚îÄ‚îÄ */
.analysis-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
}
.analysis-card h3 {
  font-size: 0.95rem;
  font-weight: 600;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.analysis-text {
  font-size: 0.85rem;
  color: var(--text-dim);
  line-height: 1.7;
}

/* ‚îÄ‚îÄ Chart ‚îÄ‚îÄ */
.chart-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  overflow: hidden;
}
.chart-title {
  font-size: 0.75rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 16px;
}
.chart-svg { width: 100%; height: 180px; }
.chart-legend {
  display: flex;
  gap: 20px;
  margin-top: 12px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.75rem;
  color: var(--text-dim);
}
.legend-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

/* ‚îÄ‚îÄ Stats Grid ‚îÄ‚îÄ */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}
.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 16px;
}
.stat-label {
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 6px;
}
.stat-value {
  font-family: 'JetBrains Mono', monospace;
  font-size: 1.4rem;
  font-weight: 600;
}
.stat-sub { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }

/* ‚îÄ‚îÄ Empty state ‚îÄ‚îÄ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-dim);
}
.empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.3; }
.empty-text { font-size: 0.9rem; line-height: 1.6; }

/* ‚îÄ‚îÄ Bottom nav ‚îÄ‚îÄ */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(10, 15, 26, 0.92);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  padding: 10px 0;
  padding-bottom: max(10px, env(safe-area-inset-bottom));
  z-index: 100;
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px 16px;
  font-family: 'DM Sans', sans-serif;
  font-size: 0.65rem;
  font-weight: 500;
  transition: color 0.2s;
}
.nav-item.active { color: var(--accent); }
.nav-icon { font-size: 1.4rem; }

/* ‚îÄ‚îÄ Processing overlay ‚îÄ‚îÄ */
.processing-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10, 15, 26, 0.9);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
  flex-direction: column;
  gap: 20px;
}
.processing-overlay.show { display: flex; }
.spinner {
  width: 48px;
  height: 48px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.processing-text { color: var(--text-dim); font-size: 0.9rem; }

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: fixed;
  top: 20px;
  left: 20px;
  right: 20px;
  background: var(--accent);
  color: var(--bg);
  padding: 14px 20px;
  border-radius: var(--radius-sm);
  font-weight: 600;
  font-size: 0.85rem;
  text-align: center;
  z-index: 300;
  transform: translateY(-120%);
  transition: transform 0.3s ease;
}
.toast.show { transform: translateY(0); }

/* ‚îÄ‚îÄ Captured image preview ‚îÄ‚îÄ */
.preview-container {
  position: relative;
  width: 100%;
  aspect-ratio: 4/3;
  background: #000;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 16px;
  border: 2px solid var(--accent);
}
.preview-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.preview-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  background: var(--accent);
  color: var(--bg);
  padding: 4px 12px;
  border-radius: 100px;
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ‚îÄ‚îÄ Section Headers ‚îÄ‚îÄ */
.section-header {
  font-size: 0.75rem;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  font-weight: 500;
  margin: 24px 0 12px;
}

/* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 0; }
</style>
</head>
<body>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Processing Overlay -->
<div class="processing-overlay" id="processing">
  <div class="spinner"></div>
  <div class="processing-text" id="processingText">Analyserer billede...</div>
</div>

<!-- Header -->
<div class="header">
  <div>
    <h1>BP<span>Tracker</span></h1>
  </div>
  <div class="header-date" id="headerDate"></div>
</div>

<!-- ‚ïê‚ïê‚ïê HOME SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen active" id="screenHome">
  <div class="section-header">Seneste m√•ling</div>
  <div id="latestReading">
    <div class="empty-state">
      <div class="empty-icon">‚ô°</div>
      <div class="empty-text">Ingen m√•linger endnu.<br>Tryk + for at registrere din f√∏rste m√•ling.</div>
    </div>
  </div>

  <div id="homeStats" style="display:none;">
    <div class="section-header">Denne uge</div>
    <div class="stats-grid" id="statsGrid"></div>
  </div>

  <div id="homeHistory" style="display:none;">
    <div class="section-header">Historik</div>
    <div class="history-list" id="historyList"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CAPTURE SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen" id="screenCapture">
  <div class="tabs">
    <button class="tab active" onclick="switchCaptureMode('camera')">üì∑ Kamera</button>
    <button class="tab" onclick="switchCaptureMode('manual')">‚úèÔ∏è Manuel</button>
  </div>

  <!-- Camera Mode -->
  <div id="cameraMode">
    <div class="camera-container" id="cameraContainer">
      <video id="cameraVideo" autoplay playsinline></video>
      <canvas id="cameraCanvas" style="display:none;"></canvas>
      <div class="camera-overlay" id="cameraOverlay">
        <div class="scan-frame">
          <div class="scan-line"></div>
        </div>
      </div>
    </div>
    <div class="scan-hint">
      Ret kameraet mod din blodtryksm√•lers display.<br>
      S√∏rg for at tallene er tydelige og velbelyste.
    </div>
    <div class="capture-actions">
      <button class="btn btn-primary" id="captureBtn" onclick="capturePhoto()">
        üì∏ Tag billede
      </button>
    </div>

    <!-- Preview after capture -->
    <div id="previewSection" style="display:none;">
      <div class="preview-container">
        <img id="previewImage" alt="Captured">
        <div class="preview-badge">Scannet</div>
      </div>
      <div id="ocrResult"></div>
      <div class="capture-actions" style="margin-top: 12px;">
        <button class="btn btn-secondary" onclick="retakePhoto()">‚Üª Tag nyt</button>
        <button class="btn btn-primary" onclick="confirmOCR()">‚úì Gem m√•ling</button>
      </div>
    </div>
  </div>

  <!-- Manual Mode -->
  <div id="manualMode" style="display:none;">
    <div class="input-group">
      <label class="input-label">Systolisk (√∏vre)</label>
      <input class="input-field" type="number" id="inputSys" placeholder="f.eks. 128" inputmode="numeric" pattern="[0-9]*">
    </div>
    <div class="input-group">
      <label class="input-label">Diastolisk (nedre)</label>
      <input class="input-field" type="number" id="inputDia" placeholder="f.eks. 82" inputmode="numeric" pattern="[0-9]*">
    </div>
    <div class="input-group">
      <label class="input-label">Puls</label>
      <input class="input-field" type="number" id="inputPulse" placeholder="f.eks. 72" inputmode="numeric" pattern="[0-9]*">
    </div>
    <button class="btn btn-primary" onclick="saveManual()" style="width:100%; margin-top: 8px;">
      ‚úì Gem m√•ling
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ANALYSE SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen" id="screenAnalyse">
  <div id="analyseContent">
    <div class="empty-state">
      <div class="empty-icon">üìä</div>
      <div class="empty-text">Registrer mindst 3 m√•linger<br>for at se AI-analyse af dine trends.</div>
    </div>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <button class="nav-item active" onclick="switchScreen('Home')">
    <span class="nav-icon">‚ô°</span>
    Overblik
  </button>
  <button class="nav-item" onclick="switchScreen('Capture')" style="position: relative;">
    <span class="nav-icon" style="font-size: 1.8rem; margin-top: -10px; color: var(--accent);">‚äï</span>
    Ny m√•ling
  </button>
  <button class="nav-item" onclick="switchScreen('Analyse')">
    <span class="nav-icon">üìä</span>
    Analyse
  </button>
</div>

<script>
// ‚îÄ‚îÄ Data Store ‚îÄ‚îÄ
let readings = JSON.parse(localStorage.getItem('bp_readings') || '[]');

// ‚îÄ‚îÄ Date formatting ‚îÄ‚îÄ
function formatDate(d) {
  const date = new Date(d);
  const days = ['S√∏n', 'Man', 'Tir', 'Ons', 'Tor', 'Fre', 'L√∏r'];
  const months = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
  return `${days[date.getDay()]} ${date.getDate()}. ${months[date.getMonth()]}`;
}
function formatTime(d) {
  const date = new Date(d);
  return `${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
}

// ‚îÄ‚îÄ BP Classification ‚îÄ‚îÄ
function classifyBP(sys, dia) {
  if (sys < 120 && dia < 80) return { label: 'Optimal', class: 'optimal' };
  if (sys < 130 && dia < 85) return { label: 'Normal', class: 'optimal' };
  if (sys < 140 && dia < 90) return { label: 'H√∏jt normalt', class: 'elevated' };
  if (sys < 160 && dia < 100) return { label: 'Grad 1 hypertension', class: 'high' };
  if (sys < 180 && dia < 110) return { label: 'Grad 2 hypertension', class: 'high' };
  return { label: 'Grad 3 hypertension', class: 'high' };
}

// ‚îÄ‚îÄ Save reading ‚îÄ‚îÄ
function saveReading(sys, dia, pulse, method = 'manual') {
  const reading = {
    id: Date.now(),
    sys: parseInt(sys),
    dia: parseInt(dia),
    pulse: parseInt(pulse),
    timestamp: new Date().toISOString(),
    method
  };
  readings.unshift(reading);
  localStorage.setItem('bp_readings', JSON.stringify(readings));
  renderAll();
  showToast('M√•ling gemt ‚úì');
  switchScreen('Home');
}

// ‚îÄ‚îÄ Screen Navigation ‚îÄ‚îÄ
function switchScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach((n, i) => {
    n.classList.toggle('active', 
      (name === 'Home' && i === 0) || (name === 'Capture' && i === 1) || (name === 'Analyse' && i === 2)
    );
  });
  if (name === 'Capture') {
    startCamera();
    resetCaptureUI();
  } else {
    stopCamera();
  }
  if (name === 'Analyse') renderAnalysis();
}

// ‚îÄ‚îÄ Capture Mode Toggle ‚îÄ‚îÄ
function switchCaptureMode(mode) {
  document.querySelectorAll('#screenCapture .tab').forEach((t, i) => {
    t.classList.toggle('active', (mode === 'camera' && i === 0) || (mode === 'manual' && i === 1));
  });
  document.getElementById('cameraMode').style.display = mode === 'camera' ? 'block' : 'none';
  document.getElementById('manualMode').style.display = mode === 'manual' ? 'block' : 'none';
  if (mode === 'camera') startCamera(); else stopCamera();
}

// ‚îÄ‚îÄ Camera ‚îÄ‚îÄ
let cameraStream = null;

async function startCamera() {
  try {
    const video = document.getElementById('cameraVideo');
    if (cameraStream) return;
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 960 } }
    });
    video.srcObject = cameraStream;
  } catch (e) {
    console.log('Camera not available:', e);
    document.getElementById('cameraContainer').innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100%;flex-direction:column;gap:12px;padding:20px;text-align:center;">
        <span style="font-size:2.5rem;opacity:0.3;">üì∑</span>
        <span style="color:var(--text-dim);font-size:0.85rem;">Kamera ikke tilg√¶ngeligt.<br>Brug manuel indtastning i stedet.</span>
      </div>
    `;
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
}

function capturePhoto() {
  const video = document.getElementById('cameraVideo');
  const canvas = document.getElementById('cameraCanvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.9);

  stopCamera();
  document.getElementById('cameraContainer').style.display = 'none';
  document.getElementById('cameraOverlay').style.display = 'none';
  document.querySelector('.scan-hint').style.display = 'none';
  document.getElementById('captureBtn').parentElement.style.display = 'none';

  document.getElementById('previewImage').src = dataUrl;
  document.getElementById('previewSection').style.display = 'block';

  simulateOCR(dataUrl);
}

function simulateOCR(imageData) {
  const processing = document.getElementById('processing');
  const processingText = document.getElementById('processingText');
  processing.classList.add('show');

  const steps = ['Analyserer billede...', 'Finder display...', 'Afl√¶ser v√¶rdier...', 'F√¶rdig!'];
  let step = 0;
  const interval = setInterval(() => {
    step++;
    if (step < steps.length) processingText.textContent = steps[step];
  }, 500);

  setTimeout(() => {
    clearInterval(interval);
    processing.classList.remove('show');

    // Simulate realistic OCR values
    const sys = Math.floor(Math.random() * 40) + 115;
    const dia = Math.floor(Math.random() * 20) + 70;
    const pulse = Math.floor(Math.random() * 20) + 62;
    const status = classifyBP(sys, dia);

    document.getElementById('ocrResult').innerHTML = `
      <div class="analysis-card">
        <h3>üìã Afl√¶ste v√¶rdier</h3>
        <div style="display:flex;gap:16px;margin-top:8px;">
          <div class="meta-item">
            <span class="meta-label">Systolisk</span>
            <span class="meta-value" style="font-size:1.3rem;" id="ocrSys">${sys}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Diastolisk</span>
            <span class="meta-value" style="font-size:1.3rem;" id="ocrDia">${dia}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Puls</span>
            <span class="meta-value" style="font-size:1.3rem;" id="ocrPulse">${pulse}</span>
          </div>
        </div>
        <div class="status-badge status-${status.class}" style="margin-top:12px;">
          <span class="status-dot"></span>${status.label}
        </div>
        <p style="font-size:0.75rem;color:var(--text-muted);margin-top:12px;">
          Tjek at v√¶rdierne stemmer overens med din m√•ler. Du kan rette dem manuelt f√∏r du gemmer.
        </p>
      </div>
    `;
  }, 2000);
}

function retakePhoto() {
  resetCaptureUI();
  startCamera();
}

function resetCaptureUI() {
  document.getElementById('cameraContainer').style.display = 'block';
  document.getElementById('cameraOverlay').style.display = 'flex';
  document.querySelector('.scan-hint').style.display = 'block';
  document.getElementById('captureBtn').parentElement.style.display = 'flex';
  document.getElementById('previewSection').style.display = 'none';
  document.getElementById('ocrResult').innerHTML = '';
}

function confirmOCR() {
  const sys = document.getElementById('ocrSys')?.textContent;
  const dia = document.getElementById('ocrDia')?.textContent;
  const pulse = document.getElementById('ocrPulse')?.textContent;
  if (sys && dia && pulse) saveReading(sys, dia, pulse, 'camera');
}

function saveManual() {
  const sys = document.getElementById('inputSys').value;
  const dia = document.getElementById('inputDia').value;
  const pulse = document.getElementById('inputPulse').value;
  if (!sys || !dia || !pulse) { showToast('Udfyld alle felter'); return; }
  if (sys < 60 || sys > 250 || dia < 40 || dia > 150) { showToast('V√¶rdierne ser ikke rigtige ud'); return; }
  saveReading(sys, dia, pulse, 'manual');
  document.getElementById('inputSys').value = '';
  document.getElementById('inputDia').value = '';
  document.getElementById('inputPulse').value = '';
}

// ‚îÄ‚îÄ Delete Reading ‚îÄ‚îÄ
function deleteReading(id) {
  readings = readings.filter(r => r.id !== id);
  localStorage.setItem('bp_readings', JSON.stringify(readings));
  renderAll();
  showToast('M√•ling slettet');
}

// ‚îÄ‚îÄ Render Home ‚îÄ‚îÄ
function renderHome() {
  if (readings.length === 0) {
    document.getElementById('latestReading').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">‚ô°</div>
        <div class="empty-text">Ingen m√•linger endnu.<br>Tryk + for at registrere din f√∏rste m√•ling.</div>
      </div>`;
    document.getElementById('homeStats').style.display = 'none';
    document.getElementById('homeHistory').style.display = 'none';
    return;
  }

  const latest = readings[0];
  const status = classifyBP(latest.sys, latest.dia);
  
  document.getElementById('latestReading').innerHTML = `
    <div class="latest-card">
      <div class="latest-label">Seneste m√•ling</div>
      <div class="latest-values">
        <span class="bp-big">${latest.sys}<span class="bp-slash">/</span>${latest.dia}</span>
        <span class="bp-unit">mmHg</span>
      </div>
      <div class="status-badge status-${status.class}">
        <span class="status-dot"></span>${status.label}
      </div>
      <div class="latest-meta">
        <div class="meta-item">
          <span class="meta-label">Puls</span>
          <span class="meta-value">${latest.pulse} <span style="font-size:0.7rem;color:var(--text-dim);">bpm</span></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Tidspunkt</span>
          <span class="meta-value" style="font-family:'DM Sans';font-weight:500;font-size:0.85rem;">${formatDate(latest.timestamp)}, ${formatTime(latest.timestamp)}</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Metode</span>
          <span class="meta-value" style="font-family:'DM Sans';font-weight:500;font-size:0.85rem;">${latest.method === 'camera' ? 'üì∑' : '‚úèÔ∏è'}</span>
        </div>
      </div>
    </div>`;

  // Stats
  if (readings.length >= 2) {
    document.getElementById('homeStats').style.display = 'block';
    const weekReadings = readings.filter(r => {
      const diff = Date.now() - new Date(r.timestamp).getTime();
      return diff < 7 * 24 * 60 * 60 * 1000;
    });
    const data = weekReadings.length > 0 ? weekReadings : readings.slice(0, 7);
    const avgSys = Math.round(data.reduce((a, r) => a + r.sys, 0) / data.length);
    const avgDia = Math.round(data.reduce((a, r) => a + r.dia, 0) / data.length);
    const avgPulse = Math.round(data.reduce((a, r) => a + r.pulse, 0) / data.length);
    const avgStatus = classifyBP(avgSys, avgDia);

    document.getElementById('statsGrid').innerHTML = `
      <div class="stat-card">
        <div class="stat-label">Gns. blodtryk</div>
        <div class="stat-value">${avgSys}/${avgDia}</div>
        <div class="stat-sub" style="color: var(--${avgStatus.class})">${avgStatus.label}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Gns. puls</div>
        <div class="stat-value">${avgPulse}</div>
        <div class="stat-sub">bpm</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">M√•linger</div>
        <div class="stat-value">${data.length}</div>
        <div class="stat-sub">denne uge</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">H√∏jeste sys.</div>
        <div class="stat-value">${Math.max(...data.map(r => r.sys))}</div>
        <div class="stat-sub">mmHg</div>
      </div>`;
  }

  // History
  if (readings.length > 0) {
    document.getElementById('homeHistory').style.display = 'block';
    document.getElementById('historyList').innerHTML = readings.slice(0, 10).map(r => {
      const s = classifyBP(r.sys, r.dia);
      return `
        <div class="history-item">
          <div class="history-left">
            <span class="history-bp" style="color: var(--${s.class})">${r.sys}/${r.dia}</span>
            <span class="history-time">${formatDate(r.timestamp)} kl. ${formatTime(r.timestamp)} ¬∑ ${r.method === 'camera' ? 'üì∑' : '‚úèÔ∏è'}</span>
          </div>
          <div class="history-right">
            <span class="history-pulse">‚ô° ${r.pulse}</span>
            <button class="delete-btn" onclick="deleteReading(${r.id})">‚úï</button>
          </div>
        </div>`;
    }).join('');
  }
}

// ‚îÄ‚îÄ Render Analysis ‚îÄ‚îÄ
function renderAnalysis() {
  if (readings.length < 3) {
    document.getElementById('analyseContent').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <div class="empty-text">Registrer mindst 3 m√•linger<br>for at se AI-analyse af dine trends.</div>
      </div>`;
    return;
  }

  const recent = readings.slice(0, 14);
  const avgSys = Math.round(recent.reduce((a, r) => a + r.sys, 0) / recent.length);
  const avgDia = Math.round(recent.reduce((a, r) => a + r.dia, 0) / recent.length);
  const avgPulse = Math.round(recent.reduce((a, r) => a + r.pulse, 0) / recent.length);
  const maxSys = Math.max(...recent.map(r => r.sys));
  const minSys = Math.min(...recent.map(r => r.sys));
  const status = classifyBP(avgSys, avgDia);

  // Generate chart
  const chartData = [...recent].reverse();
  const chartW = 320;
  const chartH = 150;
  const padL = 5;
  const padR = 5;
  const padT = 10;
  const padB = 10;
  const sysMin = Math.min(...chartData.map(r => r.dia)) - 10;
  const sysMax = Math.max(...chartData.map(r => r.sys)) + 10;
  
  function toX(i) { return padL + (i / (chartData.length - 1)) * (chartW - padL - padR); }
  function toY(v) { return padT + ((sysMax - v) / (sysMax - sysMin)) * (chartH - padT - padB); }

  const sysPath = chartData.map((r, i) => `${i === 0 ? 'M' : 'L'}${toX(i)},${toY(r.sys)}`).join(' ');
  const diaPath = chartData.map((r, i) => `${i === 0 ? 'M' : 'L'}${toX(i)},${toY(r.dia)}`).join(' ');
  const sysArea = sysPath + ` L${toX(chartData.length-1)},${chartH} L${toX(0)},${chartH} Z`;
  const diaArea = diaPath + ` L${toX(chartData.length-1)},${chartH} L${toX(0)},${chartH} Z`;

  // Generate AI insight
  let insight = '';
  if (avgSys < 120 && avgDia < 80) {
    insight = `Dit gennemsnitlige blodtryk p√• ${avgSys}/${avgDia} mmHg er <strong>optimalt</strong>. Det er rigtig flot! Bliv ved med at holde en sund livsstil med regelm√¶ssig motion, begr√¶nset saltindtag og god s√∏vn.`;
  } else if (avgSys < 130 && avgDia < 85) {
    insight = `Dit gennemsnitlige blodtryk p√• ${avgSys}/${avgDia} mmHg er <strong>normalt</strong>, men det kan stadig forbedres. Overvej at reducere saltindtag, √∏ge fysisk aktivitet og sikre mindst 7 timers s√∏vn om natten.`;
  } else if (avgSys < 140 && avgDia < 90) {
    insight = `Dit gennemsnitlige blodtryk p√• ${avgSys}/${avgDia} mmHg er <strong>h√∏jt normalt</strong>. Det er i gr√¶nseomr√•det og b√∏r overv√•ges t√¶t. Livsstils√¶ndringer som mere motion, v√¶gttab, reduceret alkohol og salt kan hj√¶lpe. Overvej at dr√∏fte det med din l√¶ge.`;
  } else {
    insight = `Dit gennemsnitlige blodtryk p√• ${avgSys}/${avgDia} mmHg indikerer <strong>forh√∏jet blodtryk</strong>. Det anbefales at du kontakter din l√¶ge for r√•dgivning. I mellemtiden kan livsstils√¶ndringer som daglig motion, DASH-di√¶ten, reduceret salt og stressh√•ndtering hj√¶lpe.`;
  }

  const variation = maxSys - minSys;
  let variationNote = '';
  if (variation > 30) {
    variationNote = `<br><br>üìå <strong>Bem√¶rk:</strong> Din systoliske variation er ${variation} mmHg, hvilket er relativt h√∏jt. Store udsving kan skyldes stress, koffein, fysisk aktivitet eller tidspunkt p√• dagen. Pr√∏v at m√•le p√• samme tidspunkt dagligt for mere konsistente resultater.`;
  }

  document.getElementById('analyseContent').innerHTML = `
    <div class="chart-container">
      <div class="chart-title">Blodtryk over tid</div>
      <svg class="chart-svg" viewBox="0 0 ${chartW} ${chartH}">
        <!-- Reference lines -->
        <line x1="${padL}" y1="${toY(120)}" x2="${chartW-padR}" y2="${toY(120)}" stroke="var(--border)" stroke-dasharray="4 4" />
        <line x1="${padL}" y1="${toY(80)}" x2="${chartW-padR}" y2="${toY(80)}" stroke="var(--border)" stroke-dasharray="4 4" />
        <!-- Area fills -->
        <path d="${sysArea}" fill="rgba(34, 211, 167, 0.08)" />
        <!-- Lines -->
        <path d="${sysPath}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />
        <path d="${diaPath}" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.7" />
        <!-- Dots -->
        ${chartData.map((r, i) => `<circle cx="${toX(i)}" cy="${toY(r.sys)}" r="3.5" fill="var(--accent)" />`).join('')}
        ${chartData.map((r, i) => `<circle cx="${toX(i)}" cy="${toY(r.dia)}" r="2.5" fill="#6366f1" opacity="0.7" />`).join('')}
      </svg>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--accent);"></div> Systolisk</div>
        <div class="legend-item"><div class="legend-dot" style="background:#6366f1;"></div> Diastolisk</div>
        <div class="legend-item" style="margin-left:auto;font-family:'JetBrains Mono';font-size:0.7rem;">- - 120/80</div>
      </div>
    </div>

    <div class="analysis-card">
      <h3>ü§ñ AI Sundhedsanalyse</h3>
      <div class="analysis-text">
        ${insight}${variationNote}
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Gns. systolisk</div>
        <div class="stat-value" style="color: var(--${status.class})">${avgSys}</div>
        <div class="stat-sub">mmHg</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Gns. diastolisk</div>
        <div class="stat-value" style="color: var(--${status.class})">${avgDia}</div>
        <div class="stat-sub">mmHg</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Gns. puls</div>
        <div class="stat-value">${avgPulse}</div>
        <div class="stat-sub">bpm</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Sys. variation</div>
        <div class="stat-value">${variation}</div>
        <div class="stat-sub">mmHg sp√¶nd</div>
      </div>
    </div>

    <div class="analysis-card">
      <h3>üí° Anbefalinger</h3>
      <div class="analysis-text">
        ‚Ä¢ M√•l dit blodtryk p√• samme tidspunkt hver dag for bedre sammenligning<br><br>
        ‚Ä¢ Sid stille i 5 minutter f√∏r m√•ling<br><br>
        ‚Ä¢ Undg√• koffein og motion 30 min. f√∏r m√•ling<br><br>
        ‚Ä¢ Del dine data med din l√¶ge ved n√¶ste konsultation
      </div>
    </div>

    <p style="font-size:0.7rem;color:var(--text-muted);text-align:center;margin-top:24px;line-height:1.5;">
      ‚öïÔ∏è Denne analyse er kun vejledende og erstatter ikke professionel medicinsk r√•dgivning.
      Kontakt altid din l√¶ge ved bekymringer om dit blodtryk.
    </p>
  `;
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ‚îÄ‚îÄ Render All ‚îÄ‚îÄ
function renderAll() {
  renderHome();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
document.getElementById('headerDate').textContent = formatDate(new Date());
renderAll();

// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(() => {
    console.log('BPTracker PWA ready');
  });
}
</script>
</body>
</html>
